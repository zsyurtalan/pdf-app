{% extends "base.html" %}

{% block title %}Kütüphane - PDF Öğrenme Uygulaması{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">
                <i class="fas fa-book"></i>
                PDF Kütüphanem
            </h1>
            <a href="/" class="btn">
                <i class="fas fa-plus"></i>
                Yeni PDF Yükle
            </a>
        </div>
        
        {% if pdfs %}
            <p class="text-gray-600 mb-4">Toplam {{ pdfs|length }} PDF dosyası</p>
        {% else %}
            <div class="text-center text-gray-600 py-8">
                <i class="fas fa-book-open" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                <h3 class="text-lg font-semibold mb-2">Henüz PDF yüklenmemiş</h3>
                <p class="mb-4">İlk PDF dosyanızı yükleyerek başlayın</p>
                <a href="/" class="btn">
                    <i class="fas fa-upload"></i>
                    PDF Yükle
                </a>
            </div>
        {% endif %}
    </div>

    {% if pdfs %}
    <div class="grid grid-2">
        {% for pdf in pdfs %}
        <div class="card">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold mb-2">{{ pdf.name }}</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><i class="fas fa-calendar"></i> {{ pdf.upload_date.strftime('%Y-%m-%d') }}</p>
                        <p><i class="fas fa-file"></i> {{ (pdf.size / 1024 / 1024)|round(2) }} MB</p>
                        <p><i class="fas fa-clock"></i> {{ pdf.upload_date.strftime('%H:%M') }}</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <a href="/quiz/{{ pdf.id }}" class="btn btn-success">
                        <i class="fas fa-play"></i>
                        Quiz Çöz
                    </a>
                    <button onclick="deletePdf('{{ pdf.id }}', '{{ pdf.name }}')" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                        Sil
                    </button>
                </div>
            </div>
            
            <div class="flex gap-2">
                <a href="/download/{{ pdf.id }}/summary" class="btn btn-secondary text-sm">
                    <i class="fas fa-download"></i>
                    Özet İndir
                </a>
                <a href="/download/{{ pdf.id }}/quiz" class="btn btn-secondary text-sm">
                    <i class="fas fa-download"></i>
                    Quiz İndir
                </a>
            </div>
            
            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <h4 class="font-semibold text-sm mb-2">İstatistikler</h4>
                <div class="grid grid-2 text-sm text-gray-600">
                    <div class="cursor-pointer hover:text-blue-600 transition-colors" onclick="showStatistics('{{ pdf.id }}')">
                        <i class="fas fa-chart-line"></i>
                        <span>İşlenmiş</span>
                    </div>
                    <div>
                        <i class="fas fa-question-circle"></i>
                        <span>Quiz Hazır</span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- İstatistik Modal -->
<div id="statisticsModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-xl font-bold">PDF İstatistikleri</h3>
            <button onclick="closeStatisticsModal()" class="close-btn" title="Kapat">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="statisticsContent">
                <!-- İstatistikler buraya yüklenecek -->
            </div>
        </div>
    </div>
</div>

<style>
.space-y-1 > * + * {
    margin-top: 0.25rem;
}

.grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.btn-danger {
    background: #dc2626;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background-color 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.btn-danger:hover {
    background: #b91c1c;
}

/* Mesaj toast stilleri */
.message-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 400px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.message-toast.show {
    transform: translateX(0);
}

.message-success {
    background: #10b981;
    color: white;
    border-left: 4px solid #059669;
}

.message-error {
    background: #ef4444;
    color: white;
    border-left: 4px solid #dc2626;
}

.message-info {
    background: #3b82f6;
    color: white;
    border-left: 4px solid #2563eb;
}

.message-content {
    display: flex;
    align-items: center;
    gap: 8px;
}

.message-content i {
    font-size: 16px;
}

/* Modal Stilleri */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal.hidden {
    display: none !important;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: #6b7280;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    line-height: 1;
}

.close-btn:hover {
    color: #374151;
    background: #f3f4f6;
}

.close-btn:active {
    transform: scale(0.95);
}

.modal-body {
    padding: 1.5rem;
}

.statistics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #1e40af;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6b7280;
    font-size: 0.875rem;
}

.quiz-levels {
    margin-top: 1rem;
}

.level-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.level-name {
    font-weight: 500;
    color: #374151;
}

.level-count {
    background: #3b82f6;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 500;
}

@media (max-width: 768px) {
    .grid-2 {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Mesaj gösterme fonksiyonu
function showMessage(message, type = 'info') {
    // Mevcut mesajları temizle
    const existingMessages = document.querySelectorAll('.message-toast');
    existingMessages.forEach(msg => msg.remove());
    
    // Yeni mesaj oluştur
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-toast message-${type}`;
    messageDiv.innerHTML = `
        <div class="message-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Sayfaya ekle
    document.body.appendChild(messageDiv);
    
    // Animasyon için kısa gecikme
    setTimeout(() => {
        messageDiv.classList.add('show');
    }, 100);
    
    // 3 saniye sonra kaldır
    setTimeout(() => {
        messageDiv.classList.remove('show');
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 3000);
}

async function deletePdf(pdfId, pdfName) {
    // Onay iste
    if (!confirm(`"${pdfName}" PDF'ini silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
        return;
    }
    
    try {
        console.log(`Deleting PDF: ${pdfId}`);
        
        const response = await fetch(`/delete_pdf/${pdfId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Silme işlemi başarısız');
        }
        
        // Backend'den gelen mesajı göster
        const message = result.message || 'PDF başarıyla silindi!';
        showMessage(message, 'success');
        
        // Sayfayı yenile
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Delete error:', error);
        showMessage('Hata: ' + error.message, 'error');
    }
}

// İstatistik modal fonksiyonları
async function showStatistics(pdfId) {
    try {
        console.log('Loading statistics for PDF:', pdfId);
        
        const response = await fetch(`/api/statistics/${pdfId}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'İstatistikler yüklenemedi');
        }
        
        displayStatistics(data);
        document.getElementById('statisticsModal').classList.remove('hidden');
        
    } catch (error) {
        console.error('Statistics error:', error);
        showMessage('Hata: ' + error.message, 'error');
    }
}

function displayStatistics(data) {
    const content = document.getElementById('statisticsContent');
    
    let html = `
        <div class="statistics-grid">
            <div class="stat-card">
                <div class="stat-value">${data.total_questions || 0}</div>
                <div class="stat-label">Toplam Soru</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.completed_quizzes || 0}</div>
                <div class="stat-label">Tamamlanan Quiz</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.correct_answers || 0}</div>
                <div class="stat-label">Doğru Cevap</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.wrong_answers || 0}</div>
                <div class="stat-label">Yanlış Cevap</div>
            </div>
        </div>
        
        <div class="quiz-levels">
            <h4 class="font-semibold mb-3">Quiz Seviyeleri</h4>
            <div class="level-item">
                <span class="level-name">🟢 Kolay</span>
                <span class="level-count">${data.easy_questions || 0} soru</span>
            </div>
            <div class="level-item">
                <span class="level-name">🟡 Orta</span>
                <span class="level-count">${data.medium_questions || 0} soru</span>
            </div>
            <div class="level-item">
                <span class="level-name">🔴 Zor</span>
                <span class="level-count">${data.hard_questions || 0} soru</span>
            </div>
        </div>
        
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
            <h4 class="font-semibold text-blue-800 mb-2">📊 Başarı Oranı</h4>
            <div class="text-2xl font-bold text-blue-600">
                ${data.success_rate || 0}%
            </div>
            <canvas id="successChart" width="300" height="150"></canvas>
            <p class="text-sm text-blue-600 mt-1">
                ${data.correct_answers || 0} / ${data.total_questions || 0} soru doğru
            </p>
        </div>
    `;
    
    content.innerHTML = html;
    // Grafik oluştur
    setTimeout(() => {
        if (window.Chart) {
            const ctx = document.getElementById('successChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Doğru', 'Yanlış'],
                    datasets: [{
                        data: [data.correct_answers || 0, data.wrong_answers || 0],
                        backgroundColor: ['#38bdf8', '#f87171'],
                    }]
                },
                options: {
                    responsive: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    }, 300);
}

function closeStatisticsModal() {
    console.log('Closing statistics modal');
    const modal = document.getElementById('statisticsModal');
    modal.classList.add('hidden');
}

// Modal dışına tıklayınca kapat
document.addEventListener('click', function(event) {
    const modal = document.getElementById('statisticsModal');
    if (event.target === modal) {
        closeStatisticsModal();
    }
});

// ESC tuşu ile kapat
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('statisticsModal');
        if (!modal.classList.contains('hidden')) {
            closeStatisticsModal();
        }
    }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
